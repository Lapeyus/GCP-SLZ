name: Deploy static content to Pages

on:
  push:
    branches: ['main']

  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  tfdocs:
    name: 'Terraform docs'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Render terraform docs inside the tfdocs.md and push changes back to PR branch
        uses: terraform-docs/gh-actions@v1.0.0
        with:
          working-dir: ./terraform
          output-file:  ./documentation/docs/tfdocs.md
          output-method: replace
          git-push: "true"
  doxygenate:
    name: 'Custom documentation as code'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: doxygen
      run: |
        python documentation/scripts/doxygen.py terraform/slz-folders-core.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/seed.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/slz-projects-sharedvpc.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/slz-groups-iam.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/slz-groups.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/slz-org-policy.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/slz-projects-billing.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/slz-projects-cicd.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/slz-projects-log-monitor.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/bu-folders.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/bu-groups.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/bu-projects.tf ./documentation/docs/ \
        && python documentation/scripts/doxygen.py terraform/bu-tfstate-buckets.tf ./documentation/docs/

    - name: Install Graphviz
      run: |
        sudo apt-get update
        sudo apt-get install -y graphviz

    - name: Install dependencies
      run: |
        pip install pyhcl graphviz

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Graph the GCP folders
      run: python documentation/scripts/generate_folder_digraph.py './terraform/slz-folders-core.tf'

    - name: Commit and push generated image
      run: |
        git add ./documentation/docs/img/
        git diff --cached --exit-code || (git  commit -m "Add autogenerated images [ci skip]" &&     git push origin HEAD:${{ github.ref }})
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [tfdocs,doxygenate]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Pages
        uses: actions/configure-pages@v3
      - uses: actions/setup-python@v2
        with:
          python-version: 3.x
      - run: pip install mkdocs
      - run: pip install mkdocs-material
      - run: pip install mkdocs-macros-plugin
      - run: mkdocs gh-deploy --config-file documentation/mkdocs.yml  --force --clean --verbose
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: 'documentation/site/'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

